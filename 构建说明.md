# Obsidian Plugin 项目构建说明

本项目是基于 Monorepo 架构的 Obsidian 插件集合，使用 pnpm 作为包管理工具，Turborepo 作为构建系统，并在子项目中使用 Vite 进行构建打包。本文档提供了整个项目的构建和开发相关说明。

## 环境要求

- Node.js >= 16.0.0
- pnpm >= 7.0.0

## Monorepo 架构说明

本项目采用 Monorepo 架构，包含以下主要部分：

- `/apps`: 存放独立的应用程序，如 Obsidian 插件
  - `/obsidian-format-toolkit`: 格式化工具包插件
  - `/obsidian-plugin`: 基础插件模板
- `/packages`: 存放可复用的库和模块
- `/assets`: 存放共享资源

## 包管理

本项目使用 pnpm 作为包管理工具，相比 npm 和 yarn，pnpm 有以下优势：

1. 磁盘空间使用更高效（使用硬链接共享依赖）
2. 更快的安装速度
3. 更严格的依赖管理，避免幽灵依赖问题
4. 良好的 Monorepo 支持

### 常用 pnpm 命令

- `pnpm install` - 安装整个项目的所有依赖
- `pnpm add <package> -w` - 向根工作区添加依赖
- `pnpm add <package> --filter <app-name>` - 向特定子项目添加依赖
- `pnpm remove <package> --filter <app-name>` - 从特定子项目移除依赖
- `pnpm -r update` - 更新所有子项目的依赖

## Turborepo 构建系统

本项目使用 Turborepo 作为构建系统，它能够智能地缓存构建结果、并行处理任务，并优化工作流程。

### 主要构建命令

根目录的 `package.json` 定义了以下脚本：

- `pnpm dev` - 启动 obsidian-plugin 的开发模式
- `pnpm build` - 构建所有子项目
- `pnpm lint` - 对所有子项目运行代码检查
- `pnpm test` - 运行所有子项目的测试
- `pnpm clean` - 清理所有构建缓存和依赖

要运行特定子项目的命令，可以使用 filter 标志：

```bash
pnpm --filter obsidian-format-toolkit dev
pnpm --filter obsidian-plugin build
```

## 子项目：obsidian-format-toolkit

### 目录结构

```
apps/obsidian-format-toolkit/
├── src/              # 源代码目录
│   ├── main.ts       # 主入口文件
│   ├── lib/          # 通用库和工具函数
│   ├── types/        # 类型定义
│   ├── exportFormats/# 导出格式相关功能
│   └── toggleTagWrapper/ # 标签处理相关功能
├── main.js           # 构建后的输出文件(被.gitignore忽略)
├── vite.config.ts    # Vite配置文件
├── tsconfig.json     # TypeScript配置
├── package.json      # 项目依赖和脚本配置
├── .npmrc            # npm/pnpm配置文件
├── manifest.json     # Obsidian插件元数据
└── styles.css        # 插件样式
```

### 构建配置

此子项目使用 Vite 进行构建，配置文件位于 `vite.config.ts`，主要设置包括：

1. **输入输出配置**:
   - 入口文件: `src/main.ts`
   - 输出格式: CommonJS (cjs)
   - 输出文件名: `main.js`
   - 输出目录: 项目根目录

2. **构建命令**:
   - `pnpm dev` - 开发模式构建，支持监视文件变更并自动重新构建
   - `pnpm build` - 生产模式构建，生成优化后的代码

## 子项目：obsidian-plugin

### 目录结构

```
apps/obsidian-plugin/
├── src/              # 源代码目录
│   └── main.ts       # 主入口文件
├── vite.config.ts    # Vite配置文件
├── tsconfig.json     # TypeScript配置（继承自根目录的基础配置）
├── package.json      # 项目依赖和脚本配置
├── manifest.json     # Obsidian插件元数据
└── styles.css        # 插件样式
```

### 构建配置

此子项目同样使用 Vite 进行构建，但其 TypeScript 配置继承自根目录的 `tsconfig.base.json`。

## TypeScript 配置说明

项目使用分层的 TypeScript 配置：

1. **根目录 `tsconfig.base.json`**:
   - 定义基础的编译器选项和配置
   - 被子项目引用和继承

2. **obsidian-plugin 的 `tsconfig.json`**:
   - 继承根目录的基础配置
   - 添加特定于该项目的路径映射
   - 仅包含 `src` 目录下的文件

3. **obsidian-format-toolkit 的 `tsconfig.json`**:
   - 独立的完整配置
   - 包含项目中所有 TypeScript 文件
   - 添加了特定依赖的类型声明

## 导入路径规范

在项目中，推荐使用相对路径导入模块，避免使用绝对路径：

```typescript
// 推荐的导入方式（相对路径）
import { getHeadingText } from '../../../lib/utils';

// 避免使用的导入方式（绝对路径）
// import { getHeadingText } from 'src/lib/utils';
```

这样做是因为 Vite 默认不会解析以 'src/' 开头的非相对路径导入。

## .gitignore 配置

项目中的 `.gitignore` 配置已设置为忽略以下文件：

- 构建输出文件 (`/main.js`, `manifest.json`, `dist`)
- 依赖目录 (`node_modules`)
- 编辑器配置 (`.vscode`, `.idea`)
- 操作系统文件 (`.DS_Store`)
- 调试和缓存文件 (`*.map`, `data.json`)

注意，每个子目录的 `.gitignore` 只对该目录及其子目录有效。

## 常见问题解决

1. **依赖安装问题**:
   - 如果遇到依赖冲突，尝试 `pnpm install --force`
   - 对于某些旧的依赖，可能需要在 `.npmrc` 中设置 `legacy-peer-deps=true`

2. **构建失败**:
   - 检查 TypeScript 错误，可通过 `pnpm --filter <project-name> tsc --noEmit` 验证
   - 确认所有导入路径是否正确
   - 验证 Vite 配置中的入口文件路径

3. **子项目间引用问题**:
   - 确认 `tsconfig.json` 中的 `paths` 配置正确
   - 检查 Turborepo 的依赖配置是否正确设置

4. **Vite 警告处理**:
   - 如果看到"Vite's Node API is deprecated"警告，需要考虑更新配置使用 ESM 格式 